Repository summary: AlexeyIgnatev/brics-pay-backend

1) Purpose
- Backend service (NestJS) for BRICS Pay that bridges fiat banking operations and crypto token transfers.
- Authenticates users against the BRICS Internet Banking portal (via Basic Auth to this API, then programmatic login to BRICS) and maintains user wallet records in PostgreSQL (Prisma ORM).
- Exposes REST endpoints for:
  - users/info: fetch user info and associated wallets/balances (SOM from BRICS; ESOM from Ethereum; derived addresses for BTC/ETH/USDT-TRC20).
  - payments/fiat-to-crypto: debit fiat (SOM) via BRICS and mint/credit ESOM on-chain to the user.
  - payments/crypto-to-fiat: burn/transfer ESOM from user and credit fiat (SOM) via BRICS.
  - payments/transfer: internal transfers of ESOM or SOM between users.
- API documented with Swagger at /api.

2) General setup
- Tech stack: Node.js (NestJS 11, TypeScript), Prisma 6, PostgreSQL, Web3 (Ethereum), Axios/Cheerio for BRICS portal integration, optional Redis.
- Runtime ports:
  - API: 8000 (CORS enabled; URI versioning configured).
  - pgAdmin (dev docker-compose): 5050.
- Environment variables: copy .env.example to .env and adjust. Key variables include:
  - DATABASE_URL
  - BRICS_API_ROOT, CT_ACCOUNT_NO (used by BricsService)
  - RPC_URL, TOKEN_ADDRESS (ESOM contract), ADMIN_ADDRESS, ADMIN_PRIVATE_KEY (used by EthereumService)
  - PLATFORM_FEE
  - POSTGRES_* for DB connectivity; REDIS_* if using Redis
  Note: .env.example lists PRIVATE_ADMIN_KEY, whereas code expects ADMIN_PRIVATE_KEY.
- Local development:
  - npm install
  - Ensure Postgres is running and DATABASE_URL is valid.
  - npx prisma generate (Docker does this; locally do it once)
  - npx prisma migrate deploy (or migrate dev) to apply schema
  - npm run start:dev (starts Nest with watch on port 8000)
- Dockerized setup:
  - Dev: docker-compose.yaml provides postgres and pgadmin
    - make run-dev (builds and starts) / make stop-dev (stops)
  - Prod: docker-compose.production.yaml builds service image + postgres
    - make run-prod / make stop-prod
  - Dockerfile: Ubuntu 24.04 base, installs Node 20 via fnm, installs deps, prisma generate, build, exposes 8000 and 587, entrypoint waits for DB and runs prisma migrate deploy then starts app.
- Linting/formatting:
  - ESLint 9 + typescript-eslint 8, Prettier integrated (eslint-plugin-prettier/recommended)
  - Config: eslint.config.mjs, .prettierrc (singleQuote, trailingComma=all)
  - Scripts: npm run lint, npm run format
- Testing:
  - Jest configured in package.json (ts-jest), e2e example in test/app.e2e-spec.ts
  - Scripts: npm test, npm run test:e2e, etc.
- Swagger:
  - Config in src/config/swagger; metadata in src/metadata.ts
  - Basic auth scheme named "Basic"; UI at /api

3) Repository structure (high level)
- src/
  - main.ts: bootstrap (logging, versioning, CORS, Swagger)
  - app.module.ts, app.controller.ts, app.service.ts
  - users/: controller, service, module, dto/, enums/
  - payments/: controller, service, module, dto/
  - admin-management/, user-management/, transactions/, blockchain-config/: modules (+controllers), DTOs referenced by metadata
  - common/: common.controller-default.ts, common.service.ts, dto/, guards/ (BasicAuthGuard), params/, entities/
  - config/
    - brics/: BricsService (axios + cheerio to interact with BRICS portal)
    - ethereum/: EthereumService (Web3 interactions with ESOM token), module
    - crypto/: CryptoService (derive BTC, ETH, TRX addresses from a private key), module
    - prisma/: PrismaService (connect on module init)
    - redis/: RedisService (ioredis wrapper)
    - swagger/: Swagger setup and plugin metadata loader
  - metadata.ts: swagger plugin metadata generator (autogenerated)
- prisma/
  - schema.prisma: Postgres datasource; Customer model {customer_id, address, private_key}
  - migrations/
- test/: e2e example and jest config
- tooling/config: Dockerfile, docker-compose.yaml, docker-compose.production.yaml, Makefile, eslint.config.mjs, .prettierrc, tsconfig*.json, nest-cli.json

CI and workflows
- .github directory not present in this repository; no GitHub Actions workflows detected.
- No .pre-commit-config.yaml found; pre-commit is not configured.
- Available quality scripts to run locally/CI if added: npm run lint, npm test, npm run build.

Notes and operational flow
- Authentication: Endpoints requiring @UseGuards(BasicAuthGuard) expect an Authorization: Basic header. The guard decodes credentials and calls UsersService.getUserInfo(), which logs into BRICS and ensures a user record exists (creating an ETH address if needed) before attaching user info to the request.
- Fiatâ†”Crypto flows (PaymentsService):
  - fiat-to-crypto: BRICS internal bank transfer (fiat) then EthereumService.transferFromFiat() to credit ESOM (less platform fee)
  - crypto-to-fiat: user signs on-chain transferToFiat(), then admin BRICS transfer to user (amount reduced by platform fee)
- Balances: SOM via BRICS endpoints; ESOM via ERC-20 balanceOf().
- Swagger security: Basic auth; models and controllers surfaced under /api.
